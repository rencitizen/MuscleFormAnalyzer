# MuscleFormAnalyzer (Tenax Fit)

動画から姿勢推定を行い、ユーザーの身長を元に実寸法（cm単位）で体の各部位を計測し、エクササイズフォームを分析するツール。

## 機能

### コア機能
- 身長情報に基づいたピクセルからcm単位への変換
- MediaPipeを使用した姿勢推定
- 両腕の長さ（肩～手首）の計測
- 両脚の長さ（股関節～足首）の計測
- 各関節の3D位置（cm単位）の算出
- 結果のJSON出力

### 新機能（v2.0）
- **食事分析機能**: 写真から食品を識別し、カロリーとPFCバランスを計算
- **エクササイズデータベース**: 豊富な運動種目の検索と詳細情報
- **運動位相検出**: エクササイズの5つの位相（setup, descent, bottom, ascent, top）を自動検出
- **データ収集・前処理**: MLモデル訓練用のデータ収集と前処理パイプライン

## 使い方

### コマンドラインから実行

```bash
python run_cli.py
```

初回起動時は身長を入力するように促されます。前回の値が保存されている場合はそれを使用するかどうか選択できます。

### 必要なもの

- MP4形式の動画ファイル
- 被験者の身長情報（cm）

### 分析結果

分析結果は `results/body_metrics.json` に保存されます。以下のような形式で出力されます：

```json
{
  "user_height_cm": 170,
  "left_arm_cm": 61.4,
  "right_arm_cm": 60.9,
  "left_leg_cm": 91.2,
  "right_leg_cm": 90.8,
  "joints_cm": {
    "LEFT_SHOULDER": {"x":-12.3,"y":145.0,"z":5.1},
    ...
  }
}
```

## 仕組み

1. 動画からMediaPipe Poseを使用してランドマークを抽出
2. 鼻から足首までの距離と身長を元にスケール係数を計算
3. 各ランドマーク間の距離をcm単位に変換
4. 3D空間での関節位置を計算
5. 結果をJSONとして保存

## 新機能の詳細

### 食事分析機能
- `/meal_analysis` - 食事写真のアップロードと分析
- 画像認識による食品の自動識別
- カロリー計算とPFCバランスの可視化
- 栄養履歴の保存と管理

### エクササイズデータベース
- `/exercise_database` - エクササイズの検索と閲覧
- カテゴリ別フィルタリング（胸、背中、脚、肩、腕、体幹）
- 難易度レベル（初級、中級、上級）
- 推奨重量と詳細な実行方法

### 運動位相検出
- リアルタイムでエクササイズの位相を検出
- 自動レップカウント機能
- エクササイズ別のパラメータ調整
- 位相ごとの所要時間分析

### データ収集・前処理
- `/data_consent` - データ利用同意管理
- `/training_data_management` - トレーニングデータの管理
- 合成データ生成による学習データ拡張
- プライバシーに配慮したデータ収集

## フォルダ構成

- `main.py` - メイン実行モジュール
- `app.py` - Flaskアプリケーション
- `core/` - コア機能（分析、スケーリング、データベース）
- `ml/` - 機械学習モジュール
  - `api/` - 食事分析API
  - `models/` - 位相検出、フォーム評価モデル
  - `data_collection/` - データ収集ツール
  - `nutrition/` - 栄養計算機能
- `frontend/` - React/Next.jsフロントエンド
- `templates/` - Flaskテンプレート
- `sample_videos/` - サンプル動画用フォルダ
- `results/` - 分析結果出力先フォルダ