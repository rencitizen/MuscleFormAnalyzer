<!DOCTYPE html>
<html lang="ja" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="settings">Settings - BodyScale</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <script src="/static/js/i18n.js"></script>
    <style>
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .settings-section {
            background: var(--bs-gray-800);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--bs-gray-700);
        }
        .settings-section h3 {
            color: var(--bs-info);
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .btn-danger {
            background-color: var(--bs-red);
            border-color: var(--bs-red);
        }
        .btn-success {
            background-color: var(--bs-green);
            border-color: var(--bs-green);
        }
        .alert {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container settings-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 data-i18n="settings">âš™ï¸ è¨­å®š</h1>
            <div class="d-flex gap-2">
                <div id="languageSelector"></div>
                <a href="/" class="btn btn-outline-primary" data-i18n="back_to_main">ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹</a>
            </div>
        </div>

        <!-- è¨€èªè¨­å®š -->
        <div class="settings-section">
            <h3 data-i18n="language_settings">ğŸŒ è¨€èªè¨­å®š</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label" data-i18n="select_language">è¡¨ç¤ºè¨€èªã‚’é¸æŠ:</label>
                    <select class="form-select" id="languageSelect">
                        <option value="ja" data-i18n="japanese">æ—¥æœ¬èª</option>
                        <option value="en" data-i18n="english">English</option>
                    </select>
                    <small class="form-text text-muted" data-i18n="language_help">è¨€èªã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</small>
                </div>
            </div>
        </div>

        <!-- å€‹äººæƒ…å ±è¨­å®š -->
        <div class="settings-section">
            <h3 data-i18n="personal_info">ğŸ‘¤ å€‹äººæƒ…å ±è¨­å®š</h3>
            <form id="personalInfoForm">
                <div class="row">
                    <div class="col-md-6">
                        <label for="height" class="form-label" data-i18n="height">èº«é•· (cm):</label>
                        <input type="number" class="form-control" id="height" name="height" min="100" max="250" step="0.1">
                        <small class="form-text text-muted" data-i18n="height_help">èº«ä½“è¨ˆæ¸¬ã®ç²¾åº¦å‘ä¸Šã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</small>
                    </div>
                    <div class="col-md-6">
                        <label for="weight" class="form-label" data-i18n="weight">ä½“é‡ (kg):</label>
                        <input type="number" class="form-control" id="weight" name="weight" min="30" max="200" step="0.1">
                        <small class="form-text text-muted" data-i18n="weight_help">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç›®æ¨™ã®è¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="age" class="form-label" data-i18n="age">å¹´é½¢:</label>
                        <input type="number" class="form-control" id="age" name="age" min="13" max="100">
                    </div>
                    <div class="col-md-6">
                        <label for="gender" class="form-label" data-i18n="gender">æ€§åˆ¥:</label>
                        <select class="form-select" id="gender" name="gender">
                            <option value="" data-i18n="not_specified">æŒ‡å®šã—ãªã„</option>
                            <option value="male" data-i18n="male">ç”·æ€§</option>
                            <option value="female" data-i18n="female">å¥³æ€§</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success" data-i18n="save_settings">è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </form>
        </div>

        <!-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®š -->
        <div class="settings-section">
            <h3 data-i18n="training_settings">ğŸ‹ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®š</h3>
            <form id="trainingSettingsForm">
                <div class="row">
                    <div class="col-md-6">
                        <label for="defaultSets" class="form-label" data-i18n="default_sets">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆæ•°:</label>
                        <input type="number" class="form-control" id="defaultSets" name="defaultSets" min="1" max="10" value="3">
                    </div>
                    <div class="col-md-6">
                        <label for="defaultReps" class="form-label" data-i18n="default_reps">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›æ•°:</label>
                        <input type="number" class="form-control" id="defaultReps" name="defaultReps" min="1" max="50" value="10">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="weightUnit" class="form-label" data-i18n="weight_unit">é‡é‡å˜ä½:</label>
                        <select class="form-select" id="weightUnit" name="weightUnit">
                            <option value="kg" data-i18n="kg">ã‚­ãƒ­ã‚°ãƒ©ãƒ  (kg)</option>
                            <option value="lbs" data-i18n="lbs">ãƒãƒ³ãƒ‰ (lbs)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="restTimer" class="form-label" data-i18n="rest_timer">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¼‘æ†©æ™‚é–“ (ç§’):</label>
                        <input type="number" class="form-control" id="restTimer" name="restTimer" min="30" max="600" value="90">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success" data-i18n="save_training_settings">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </form>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="settings-section">
            <h3 data-i18n="data_management">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5 data-i18n="export_data">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h5>
                    <p class="text-muted" data-i18n="export_description">ã™ã¹ã¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                    <button class="btn btn-info" id="exportDataBtn" data-i18n="export_all_data">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
                <div class="col-md-6">
                    <h5 class="text-danger" data-i18n="delete_data">ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h5>
                    <p class="text-muted" data-i18n="delete_warning">ã™ã¹ã¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã¨è¨­å®šãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
                    <button class="btn btn-danger" id="deleteDataBtn" data-i18n="delete_all_data">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <!-- ã‚¢ãƒ—ãƒªæƒ…å ± -->
        <div class="settings-section">
            <h3 data-i18n="app_info">â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</h3>
            <div class="row">
                <div class="col-md-12">
                    <p><strong data-i18n="app_name">ã‚¢ãƒ—ãƒªå:</strong> BodyScale Pose Analyzer</p>
                    <p><strong data-i18n="version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> 2.0.0</p>
                    <p><strong data-i18n="features">ä¸»ãªæ©Ÿèƒ½:</strong></p>
                    <ul>
                        <li data-i18n="feature_form_analysis">AI ãƒ‘ãƒ¯ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ¼ãƒ åˆ†æ</li>
                        <li data-i18n="feature_body_measurement">é«˜ç²¾åº¦èº«ä½“è¨ˆæ¸¬</li>
                        <li data-i18n="feature_training_log">åŒ…æ‹¬çš„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</li>
                        <li data-i18n="feature_progress_tracking">é€²æ—ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–</li>
                        <li data-i18n="feature_multilingual">å¤šè¨€èªã‚µãƒãƒ¼ãƒˆ</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è¨€èªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ 
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector && window.i18n) {
                languageSelector.appendChild(window.i18n.createLanguageSelector());
            }

            // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadCurrentSettings();

            // è¨€èªå¤‰æ›´ã®ç›£è¦–
            const languageSelect = document.getElementById('languageSelect');
            languageSelect.addEventListener('change', function() {
                if (window.i18n) {
                    window.i18n.setLanguage(this.value);
                }
            });

            // å€‹äººæƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
            document.getElementById('personalInfoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await savePersonalSettings();
            });

            // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
            document.getElementById('trainingSettingsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveTrainingSettings();
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            document.getElementById('exportDataBtn').addEventListener('click', async function() {
                await exportUserData();
            });

            // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            document.getElementById('deleteDataBtn').addEventListener('click', async function() {
                if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    await clearUserData();
                }
            });
        });

        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                if (settings.height) {
                    document.getElementById('height').value = settings.height;
                }
                if (settings.weight) {
                    document.getElementById('weight').value = settings.weight;
                }
                if (settings.age) {
                    document.getElementById('age').value = settings.age;
                }
                if (settings.gender) {
                    document.getElementById('gender').value = settings.gender;
                }
                if (settings.defaultSets) {
                    document.getElementById('defaultSets').value = settings.defaultSets;
                }
                if (settings.defaultReps) {
                    document.getElementById('defaultReps').value = settings.defaultReps;
                }
                if (settings.weightUnit) {
                    document.getElementById('weightUnit').value = settings.weightUnit;
                }
                if (settings.restTimer) {
                    document.getElementById('restTimer').value = settings.restTimer;
                }
            } catch (error) {
                console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function savePersonalSettings() {
            const formData = new FormData(document.getElementById('personalInfoForm'));
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/save_personal_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('å€‹äººæƒ…å ±è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                } else {
                    showAlert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        async function saveTrainingSettings() {
            const formData = new FormData(document.getElementById('trainingSettingsForm'));
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/save_training_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                } else {
                    showAlert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        async function exportUserData() {
            try {
                const response = await fetch('/api/export_user_data');
                const data = await response.json();
                
                if (data.user_id) {
                    // ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bodyscale_data_${data.export_date.split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');
                } else {
                    showAlert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
                }
            } catch (error) {
                showAlert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
            }
        }

        async function clearUserData() {
            try {
                const response = await fetch('/api/clear_user_data', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('personalInfoForm').reset();
                    document.getElementById('trainingSettingsForm').reset();
                } else {
                    showAlert('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>