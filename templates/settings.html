<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title data-i18n="settings">設定 - BodyScale</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/i18n.js"></script>

</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="app-header">
                <h1 class="app-title">設定</h1>
                <p class="app-subtitle">アプリケーション設定・データ管理</p>
            </div>

            <!-- 言語設定 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">言語設定</h2>
                </div>
                <div class="card-body">
                    <form id="languageForm" class="upload-form">
                        <div class="form-group">
                            <label for="language" class="form-label">表示言語</label>
                            <select class="form-control" id="language" name="language">
                                <option value="ja">日本語</option>
                                <option value="en">English</option>
                                <option value="ko">한국어</option>
                                <option value="zh">中文</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-accent">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2v16z"/>
                            </svg>
                            言語設定を保存
                        </button>
                    </form>
                </div>
            </div>

            <!-- 個人情報設定 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">個人情報</h2>
                </div>
                <div class="card-body">
                    <form id="personalSettingsForm" class="upload-form">
                        <div class="form-grid-3">
                            <div class="form-group">
                                <label for="height" class="form-label">身長 (cm)</label>
                                <input type="number" class="form-control" id="height" name="height" min="100" max="250">
                            </div>
                            <div class="form-group">
                                <label for="weight" class="form-label">体重 (kg)</label>
                                <input type="number" class="form-control" id="weight" name="weight" min="30" max="200" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="age" class="form-label">年齢</label>
                                <input type="number" class="form-control" id="age" name="age" min="13" max="100">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="gender" class="form-label">性別</label>
                            <select class="form-control" id="gender" name="gender">
                                <option value="">指定しない</option>
                                <option value="male">男性</option>
                                <option value="female">女性</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-accent btn-lg">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2v16z"/>
                            </svg>
                            設定を保存
                        </button>
                    </form>
                </div>
            </div>

            <!-- データ管理 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">データ管理</h2>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-primary);">データエクスポート</h3>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">すべてのトレーニングデータをダウンロード</p>
                            <button class="btn btn-secondary" id="exportDataBtn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                エクスポート
                            </button>
                        </div>
                        
                        <div>
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #ef4444;">データ削除</h3>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">全記録を完全削除（復元不可）</p>
                            <button class="btn btn-secondary" id="deleteDataBtn" style="background-color: #ef4444; color: white; border-color: #ef4444;">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                                全削除
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- アプリ情報 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">アプリ情報</h2>
                </div>
                <div class="card-body">
                    <div style="color: var(--text-secondary); line-height: 1.6;">
                        <p><strong>アプリ名:</strong> BodyScale Pose Analyzer</p>
                        <p><strong>バージョン:</strong> 2.0.0</p>
                        <p><strong>主な機能:</strong></p>
                        <ul style="margin-left: 1.5rem;">
                            <li>AI パワード フォーム分析</li>
                            <li>高精度身体計測</li>
                            <li>包括的トレーニング記録</li>
                            <li>進捗データ可視化</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-container">
                <a href="/" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span class="nav-label">ホーム</span>
                </a>
                <a href="/workout_record" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 11H7a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2v-7a2 2 0 00-2-2h-2M9 11V9a2 2 0 112 0v2M9 11h6"/>
                    </svg>
                    <span class="nav-label">記録</span>
                </a>
                <a href="/dashboard" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                    <span class="nav-label">統計</span>
                </a>
                <a href="/settings" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    <span class="nav-label">設定</span>
                </a>
            </div>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 設定の読み込み
            loadSettings();

            // 言語設定フォーム送信
            document.getElementById('languageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const language = document.getElementById('language').value;
                
                fetch('/set_language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: language })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('言語設定を保存しました！');
                        location.reload(); // ページを再読み込みして言語変更を反映
                    } else {
                        alert('保存に失敗しました: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存中にエラーが発生しました');
                });
            });

            // 個人設定フォーム送信
            document.getElementById('personalSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    height: parseFloat(document.getElementById('height').value) || null,
                    weight: parseFloat(document.getElementById('weight').value) || null,
                    age: parseInt(document.getElementById('age').value) || null,
                    gender: document.getElementById('gender').value || null
                };
                
                fetch('/save_personal_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('設定を保存しました！');
                    } else {
                        alert('保存に失敗しました: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存中にエラーが発生しました');
                });
            });

            // データエクスポート
            document.getElementById('exportDataBtn').addEventListener('click', function() {
                window.location.href = '/export_user_data';
            });

            // データ削除
            document.getElementById('deleteDataBtn').addEventListener('click', function() {
                if (confirm('本当にすべてのデータを削除しますか？この操作は取り消せません。')) {
                    fetch('/clear_user_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('すべてのデータを削除しました');
                            location.reload();
                        } else {
                            alert('削除に失敗しました: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('削除中にエラーが発生しました');
                    });
                }
            });
        });

        function loadSettings() {
            fetch('/get_settings')
                .then(response => response.json())
                .then(data => {
                    if (data.height) document.getElementById('height').value = data.height;
                    if (data.weight) document.getElementById('weight').value = data.weight;
                    if (data.age) document.getElementById('age').value = data.age;
                    if (data.gender) document.getElementById('gender').value = data.gender;
                    
                    // 言語設定も読み込み
                    const currentLanguage = data.language || 'ja';
                    document.getElementById('language').value = currentLanguage;
                })
                .catch(error => {
                    console.error('設定の読み込みエラー:', error);
                });
        }
    </script>
</body>
</html>

        <!-- 言語設定 -->
        <div class="settings-section">
            <h3 data-i18n="language_settings">🌐 言語設定</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label" data-i18n="select_language">表示言語を選択:</label>
                    <select class="form-select" id="languageSelect">
                        <option value="ja" data-i18n="japanese">日本語</option>
                        <option value="en" data-i18n="english">English</option>
                    </select>
                    <small class="form-text text-muted" data-i18n="language_help">言語を変更すると、すべてのページの表示が切り替わります。</small>
                </div>
            </div>
        </div>

        <!-- 個人情報設定 -->
        <div class="settings-section">
            <h3 data-i18n="personal_info">👤 個人情報設定</h3>
            <form id="personalInfoForm">
                <div class="row">
                    <div class="col-md-6">
                        <label for="height" class="form-label" data-i18n="height">身長 (cm):</label>
                        <input type="number" class="form-control" id="height" name="height" min="100" max="250" step="0.1">
                        <small class="form-text text-muted" data-i18n="height_help">身体計測の精度向上に使用されます。</small>
                    </div>
                    <div class="col-md-6">
                        <label for="weight" class="form-label" data-i18n="weight">体重 (kg):</label>
                        <input type="number" class="form-control" id="weight" name="weight" min="30" max="200" step="0.1">
                        <small class="form-text text-muted" data-i18n="weight_help">トレーニング目標の計算に使用されます。</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="age" class="form-label" data-i18n="age">年齢:</label>
                        <input type="number" class="form-control" id="age" name="age" min="13" max="100">
                    </div>
                    <div class="col-md-6">
                        <label for="gender" class="form-label" data-i18n="gender">性別:</label>
                        <select class="form-select" id="gender" name="gender">
                            <option value="" data-i18n="not_specified">指定しない</option>
                            <option value="male" data-i18n="male">男性</option>
                            <option value="female" data-i18n="female">女性</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success" data-i18n="save_settings">設定を保存</button>
                </div>
            </form>
        </div>

        <!-- トレーニング設定 -->
        <div class="settings-section">
            <h3 data-i18n="training_settings">🏋️ トレーニング設定</h3>
            <form id="trainingSettingsForm">
                <div class="row">
                    <div class="col-md-6">
                        <label for="defaultSets" class="form-label" data-i18n="default_sets">デフォルトセット数:</label>
                        <input type="number" class="form-control" id="defaultSets" name="defaultSets" min="1" max="10" value="3">
                    </div>
                    <div class="col-md-6">
                        <label for="defaultReps" class="form-label" data-i18n="default_reps">デフォルト回数:</label>
                        <input type="number" class="form-control" id="defaultReps" name="defaultReps" min="1" max="50" value="10">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="weightUnit" class="form-label" data-i18n="weight_unit">重量単位:</label>
                        <select class="form-select" id="weightUnit" name="weightUnit">
                            <option value="kg" data-i18n="kg">キログラム (kg)</option>
                            <option value="lbs" data-i18n="lbs">ポンド (lbs)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="restTimer" class="form-label" data-i18n="rest_timer">デフォルト休憩時間 (秒):</label>
                        <input type="number" class="form-control" id="restTimer" name="restTimer" min="30" max="600" value="90">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success" data-i18n="save_training_settings">トレーニング設定を保存</button>
                </div>
            </form>
        </div>

        <!-- データ管理 -->
        <div class="settings-section">
            <h3 data-i18n="data_management">📊 データ管理</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5 data-i18n="export_data">データエクスポート</h5>
                    <p class="text-muted" data-i18n="export_description">すべてのトレーニングデータをJSON形式でダウンロードできます。</p>
                    <button class="btn btn-info" id="exportDataBtn" data-i18n="export_all_data">全データをエクスポート</button>
                </div>
                <div class="col-md-6">
                    <h5 class="text-danger" data-i18n="delete_data">データ削除</h5>
                    <p class="text-muted" data-i18n="delete_warning">すべてのトレーニング記録と設定が完全に削除されます。この操作は取り消せません。</p>
                    <button class="btn btn-danger" id="deleteDataBtn" data-i18n="delete_all_data">全データを削除</button>
                </div>
            </div>
        </div>

        <!-- アプリ情報 -->
        <div class="settings-section">
            <h3 data-i18n="app_info">ℹ️ アプリ情報</h3>
            <div class="row">
                <div class="col-md-12">
                    <p><strong data-i18n="app_name">アプリ名:</strong> BodyScale Pose Analyzer</p>
                    <p><strong data-i18n="version">バージョン:</strong> 2.0.0</p>
                    <p><strong data-i18n="features">主な機能:</strong></p>
                    <ul>
                        <li data-i18n="feature_form_analysis">AI パワード フォーム分析</li>
                        <li data-i18n="feature_body_measurement">高精度身体計測</li>
                        <li data-i18n="feature_training_log">包括的トレーニング記録</li>
                        <li data-i18n="feature_progress_tracking">進捗データ可視化</li>
                        <li data-i18n="feature_multilingual">多言語サポート</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 成功・エラーメッセージ -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 言語セレクターを追加
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector && window.i18n) {
                languageSelector.appendChild(window.i18n.createLanguageSelector());
            }

            // 現在の設定を読み込み
            loadCurrentSettings();

            // 言語変更の監視
            const languageSelect = document.getElementById('languageSelect');
            languageSelect.addEventListener('change', function() {
                if (window.i18n) {
                    window.i18n.setLanguage(this.value);
                }
            });

            // 個人情報フォームの送信
            document.getElementById('personalInfoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await savePersonalSettings();
            });

            // トレーニング設定フォームの送信
            document.getElementById('trainingSettingsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveTrainingSettings();
            });

            // データエクスポート
            document.getElementById('exportDataBtn').addEventListener('click', async function() {
                await exportUserData();
            });

            // データ削除
            document.getElementById('deleteDataBtn').addEventListener('click', async function() {
                if (confirm('本当にすべてのデータを削除しますか？この操作は取り消せません。')) {
                    await clearUserData();
                }
            });
        });

        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                if (settings.height) {
                    document.getElementById('height').value = settings.height;
                }
                if (settings.weight) {
                    document.getElementById('weight').value = settings.weight;
                }
                if (settings.age) {
                    document.getElementById('age').value = settings.age;
                }
                if (settings.gender) {
                    document.getElementById('gender').value = settings.gender;
                }
                if (settings.defaultSets) {
                    document.getElementById('defaultSets').value = settings.defaultSets;
                }
                if (settings.defaultReps) {
                    document.getElementById('defaultReps').value = settings.defaultReps;
                }
                if (settings.weightUnit) {
                    document.getElementById('weightUnit').value = settings.weightUnit;
                }
                if (settings.restTimer) {
                    document.getElementById('restTimer').value = settings.restTimer;
                }
            } catch (error) {
                console.error('設定の読み込みエラー:', error);
            }
        }

        async function savePersonalSettings() {
            const formData = new FormData(document.getElementById('personalInfoForm'));
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/save_personal_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('個人情報設定が保存されました。', 'success');
                } else {
                    showAlert('設定の保存に失敗しました: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('通信エラーが発生しました: ' + error.message, 'danger');
            }
        }

        async function saveTrainingSettings() {
            const formData = new FormData(document.getElementById('trainingSettingsForm'));
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/save_training_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('トレーニング設定が保存されました。', 'success');
                } else {
                    showAlert('設定の保存に失敗しました: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('通信エラーが発生しました: ' + error.message, 'danger');
            }
        }

        async function exportUserData() {
            try {
                const response = await fetch('/api/export_user_data');
                const data = await response.json();
                
                if (data.user_id) {
                    // データをJSONファイルとしてダウンロード
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bodyscale_data_${data.export_date.split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('データのエクスポートが完了しました。', 'success');
                } else {
                    showAlert('エクスポートするデータがありません。', 'warning');
                }
            } catch (error) {
                showAlert('エクスポートエラー: ' + error.message, 'danger');
            }
        }

        async function clearUserData() {
            try {
                const response = await fetch('/api/clear_user_data', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('すべてのデータが削除されました。', 'success');
                    // フォームをリセット
                    document.getElementById('personalInfoForm').reset();
                    document.getElementById('trainingSettingsForm').reset();
                } else {
                    showAlert('データ削除に失敗しました: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('通信エラーが発生しました: ' + error.message, 'danger');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // 5秒後に自動で消す
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>