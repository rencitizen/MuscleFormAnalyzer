<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title data-i18n="settings">è¨­å®š - BodyScale</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/i18n.js"></script>

</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="app-header">
                <h1 class="app-title">è¨­å®š</h1>
                <p class="app-subtitle">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</p>
            </div>

            <!-- è¨€èªè¨­å®š -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">è¨€èªè¨­å®š</h2>
                </div>
                <div class="card-body">
                    <form id="languageForm" class="upload-form">
                        <div class="form-group">
                            <label for="language" class="form-label">è¡¨ç¤ºè¨€èª</label>
                            <select class="form-control" id="language" name="language">
                                <option value="ja">æ—¥æœ¬èª</option>
                                <option value="en">English</option>
                                <option value="ko">í•œêµ­ì–´</option>
                                <option value="zh">ä¸­æ–‡</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-accent">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2v16z"/>
                            </svg>
                            è¨€èªè¨­å®šã‚’ä¿å­˜
                        </button>
                    </form>
                </div>
            </div>

            <!-- å€‹äººæƒ…å ±è¨­å®š -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">å€‹äººæƒ…å ±</h2>
                </div>
                <div class="card-body">
                    <form id="personalSettingsForm" class="upload-form">
                        <div class="form-grid-3">
                            <div class="form-group">
                                <label for="height" class="form-label">èº«é•· (cm)</label>
                                <input type="number" class="form-control" id="height" name="height" min="100" max="250">
                            </div>
                            <div class="form-group">
                                <label for="weight" class="form-label">ä½“é‡ (kg)</label>
                                <input type="number" class="form-control" id="weight" name="weight" min="30" max="200" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="age" class="form-label">å¹´é½¢</label>
                                <input type="number" class="form-control" id="age" name="age" min="13" max="100">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="gender" class="form-label">æ€§åˆ¥</label>
                            <select class="form-control" id="gender" name="gender">
                                <option value="">æŒ‡å®šã—ãªã„</option>
                                <option value="male">ç”·æ€§</option>
                                <option value="female">å¥³æ€§</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-accent btn-lg">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2v16z"/>
                            </svg>
                            è¨­å®šã‚’ä¿å­˜
                        </button>
                    </form>
                </div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-primary);">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">ã™ã¹ã¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</p>
                            <button class="btn btn-secondary" id="exportDataBtn">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                        
                        <div>
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #ef4444;">ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h3>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">å…¨è¨˜éŒ²ã‚’å®Œå…¨å‰Šé™¤ï¼ˆå¾©å…ƒä¸å¯ï¼‰</p>
                            <button class="btn btn-secondary" id="deleteDataBtn" style="background-color: #ef4444; color: white; border-color: #ef4444;">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                                å…¨å‰Šé™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ãƒ—ãƒªæƒ…å ± -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ã‚¢ãƒ—ãƒªæƒ…å ±</h2>
                </div>
                <div class="card-body">
                    <div style="color: var(--text-secondary); line-height: 1.6;">
                        <p><strong>ã‚¢ãƒ—ãƒªå:</strong> BodyScale Pose Analyzer</p>
                        <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> 2.0.0</p>
                        <p><strong>ä¸»ãªæ©Ÿèƒ½:</strong></p>
                        <ul style="margin-left: 1.5rem;">
                            <li>AI ãƒ‘ãƒ¯ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ¼ãƒ åˆ†æ</li>
                            <li>é«˜ç²¾åº¦èº«ä½“è¨ˆæ¸¬</li>
                            <li>åŒ…æ‹¬çš„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</li>
                            <li>é€²æ—ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-container">
                <a href="/" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span class="nav-label">ãƒ›ãƒ¼ãƒ </span>
                </a>
                <a href="/workout_record" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 11H7a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2v-7a2 2 0 00-2-2h-2M9 11V9a2 2 0 112 0v2M9 11h6"/>
                    </svg>
                    <span class="nav-label">è¨˜éŒ²</span>
                </a>
                <a href="/dashboard" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                    <span class="nav-label">çµ±è¨ˆ</span>
                </a>
                <a href="/settings" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    <span class="nav-label">è¨­å®š</span>
                </a>
            </div>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­å®šã®èª­ã¿è¾¼ã¿
            loadSettings();

            // è¨€èªè¨­å®šãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('languageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const language = document.getElementById('language').value;
                
                fetch('/set_language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: language })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('è¨€èªè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                        location.reload(); // ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦è¨€èªå¤‰æ›´ã‚’åæ˜ 
                    } else {
                        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            });

            // å€‹äººè¨­å®šãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('personalSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    height: parseFloat(document.getElementById('height').value) || null,
                    weight: parseFloat(document.getElementById('weight').value) || null,
                    age: parseInt(document.getElementById('age').value) || null,
                    gender: document.getElementById('gender').value || null
                };
                
                fetch('/save_personal_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                    } else {
                        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            document.getElementById('exportDataBtn').addEventListener('click', function() {
                window.location.href = '/export_user_data';
            });

            // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            document.getElementById('deleteDataBtn').addEventListener('click', function() {
                if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    fetch('/clear_user_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                            location.reload();
                        } else {
                            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    });
                }
            });
        });

        function loadSettings() {
            fetch('/get_settings')
                .then(response => response.json())
                .then(data => {
                    if (data.height) document.getElementById('height').value = data.height;
                    if (data.weight) document.getElementById('weight').value = data.weight;
                    if (data.age) document.getElementById('age').value = data.age;
                    if (data.gender) document.getElementById('gender').value = data.gender;
                    
                    // è¨€èªè¨­å®šã‚‚èª­ã¿è¾¼ã¿
                    const currentLanguage = data.language || 'ja';
                    document.getElementById('language').value = currentLanguage;
                })
                .catch(error => {
                    console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
    </script>
</body>
</html>

        <!-- è¨€èªè¨­å®š -->
        <div class="settings-section">
            <h3 data-i18n="language_settings">ğŸŒ è¨€èªè¨­å®š</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label" data-i18n="select_language">è¡¨ç¤ºè¨€èªã‚’é¸æŠ:</label>
                    <select class="form-select" id="languageSelect">
                        <option value="ja" data-i18n="japanese">æ—¥æœ¬èª</option>
                        <option value="en" data-i18n="english">English</option>
                    </select>
                    <small class="form-text text-muted" data-i18n="language_help">è¨€èªã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</small>
                </div>
            </div>
        </div>

        <!-- å€‹äººæƒ…å ±è¨­å®š -->
        <div class="settings-section">
            <h3 data-i18n="personal_info">ğŸ‘¤ å€‹äººæƒ…å ±è¨­å®š</h3>
            <form id="personalInfoForm">
                <div class="row">
                    <div class="col-md-6">
                        <label for="height" class="form-label" data-i18n="height">èº«é•· (cm):</label>
                        <input type="number" class="form-control" id="height" name="height" min="100" max="250" step="0.1">
                        <small class="form-text text-muted" data-i18n="height_help">èº«ä½“è¨ˆæ¸¬ã®ç²¾åº¦å‘ä¸Šã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</small>
                    </div>
                    <div class="col-md-6">
                        <label for="weight" class="form-label" data-i18n="weight">ä½“é‡ (kg):</label>
                        <input type="number" class="form-control" id="weight" name="weight" min="30" max="200" step="0.1">
                        <small class="form-text text-muted" data-i18n="weight_help">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç›®æ¨™ã®è¨ˆç®—ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="age" class="form-label" data-i18n="age">å¹´é½¢:</label>
                        <input type="number" class="form-control" id="age" name="age" min="13" max="100">
                    </div>
                    <div class="col-md-6">
                        <label for="gender" class="form-label" data-i18n="gender">æ€§åˆ¥:</label>
                        <select class="form-select" id="gender" name="gender">
                            <option value="" data-i18n="not_specified">æŒ‡å®šã—ãªã„</option>
                            <option value="male" data-i18n="male">ç”·æ€§</option>
                            <option value="female" data-i18n="female">å¥³æ€§</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success" data-i18n="save_settings">è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </form>
        </div>

        <!-- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®š -->
        <div class="settings-section">
            <h3 data-i18n="training_settings">ğŸ‹ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®š</h3>
            <form id="trainingSettingsForm">
                <div class="row">
                    <div class="col-md-6">
                        <label for="defaultSets" class="form-label" data-i18n="default_sets">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆæ•°:</label>
                        <input type="number" class="form-control" id="defaultSets" name="defaultSets" min="1" max="10" value="3">
                    </div>
                    <div class="col-md-6">
                        <label for="defaultReps" class="form-label" data-i18n="default_reps">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå›æ•°:</label>
                        <input type="number" class="form-control" id="defaultReps" name="defaultReps" min="1" max="50" value="10">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label for="weightUnit" class="form-label" data-i18n="weight_unit">é‡é‡å˜ä½:</label>
                        <select class="form-select" id="weightUnit" name="weightUnit">
                            <option value="kg" data-i18n="kg">ã‚­ãƒ­ã‚°ãƒ©ãƒ  (kg)</option>
                            <option value="lbs" data-i18n="lbs">ãƒãƒ³ãƒ‰ (lbs)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="restTimer" class="form-label" data-i18n="rest_timer">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¼‘æ†©æ™‚é–“ (ç§’):</label>
                        <input type="number" class="form-control" id="restTimer" name="restTimer" min="30" max="600" value="90">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success" data-i18n="save_training_settings">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </form>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="settings-section">
            <h3 data-i18n="data_management">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5 data-i18n="export_data">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h5>
                    <p class="text-muted" data-i18n="export_description">ã™ã¹ã¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                    <button class="btn btn-info" id="exportDataBtn" data-i18n="export_all_data">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
                <div class="col-md-6">
                    <h5 class="text-danger" data-i18n="delete_data">ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h5>
                    <p class="text-muted" data-i18n="delete_warning">ã™ã¹ã¦ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ã¨è¨­å®šãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
                    <button class="btn btn-danger" id="deleteDataBtn" data-i18n="delete_all_data">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <!-- ã‚¢ãƒ—ãƒªæƒ…å ± -->
        <div class="settings-section">
            <h3 data-i18n="app_info">â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</h3>
            <div class="row">
                <div class="col-md-12">
                    <p><strong data-i18n="app_name">ã‚¢ãƒ—ãƒªå:</strong> BodyScale Pose Analyzer</p>
                    <p><strong data-i18n="version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> 2.0.0</p>
                    <p><strong data-i18n="features">ä¸»ãªæ©Ÿèƒ½:</strong></p>
                    <ul>
                        <li data-i18n="feature_form_analysis">AI ãƒ‘ãƒ¯ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ¼ãƒ åˆ†æ</li>
                        <li data-i18n="feature_body_measurement">é«˜ç²¾åº¦èº«ä½“è¨ˆæ¸¬</li>
                        <li data-i18n="feature_training_log">åŒ…æ‹¬çš„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²</li>
                        <li data-i18n="feature_progress_tracking">é€²æ—ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–</li>
                        <li data-i18n="feature_multilingual">å¤šè¨€èªã‚µãƒãƒ¼ãƒˆ</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è¨€èªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è¿½åŠ 
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector && window.i18n) {
                languageSelector.appendChild(window.i18n.createLanguageSelector());
            }

            // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
            loadCurrentSettings();

            // è¨€èªå¤‰æ›´ã®ç›£è¦–
            const languageSelect = document.getElementById('languageSelect');
            languageSelect.addEventListener('change', function() {
                if (window.i18n) {
                    window.i18n.setLanguage(this.value);
                }
            });

            // å€‹äººæƒ…å ±ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
            document.getElementById('personalInfoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await savePersonalSettings();
            });

            // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
            document.getElementById('trainingSettingsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveTrainingSettings();
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            document.getElementById('exportDataBtn').addEventListener('click', async function() {
                await exportUserData();
            });

            // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            document.getElementById('deleteDataBtn').addEventListener('click', async function() {
                if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                    await clearUserData();
                }
            });
        });

        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                if (settings.height) {
                    document.getElementById('height').value = settings.height;
                }
                if (settings.weight) {
                    document.getElementById('weight').value = settings.weight;
                }
                if (settings.age) {
                    document.getElementById('age').value = settings.age;
                }
                if (settings.gender) {
                    document.getElementById('gender').value = settings.gender;
                }
                if (settings.defaultSets) {
                    document.getElementById('defaultSets').value = settings.defaultSets;
                }
                if (settings.defaultReps) {
                    document.getElementById('defaultReps').value = settings.defaultReps;
                }
                if (settings.weightUnit) {
                    document.getElementById('weightUnit').value = settings.weightUnit;
                }
                if (settings.restTimer) {
                    document.getElementById('restTimer').value = settings.restTimer;
                }
            } catch (error) {
                console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function savePersonalSettings() {
            const formData = new FormData(document.getElementById('personalInfoForm'));
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/save_personal_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('å€‹äººæƒ…å ±è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                } else {
                    showAlert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        async function saveTrainingSettings() {
            const formData = new FormData(document.getElementById('trainingSettingsForm'));
            const settings = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/save_training_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                } else {
                    showAlert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        async function exportUserData() {
            try {
                const response = await fetch('/api/export_user_data');
                const data = await response.json();
                
                if (data.user_id) {
                    // ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bodyscale_data_${data.export_date.split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');
                } else {
                    showAlert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
                }
            } catch (error) {
                showAlert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'danger');
            }
        }

        async function clearUserData() {
            try {
                const response = await fetch('/api/clear_user_data', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('personalInfoForm').reset();
                    document.getElementById('trainingSettingsForm').reset();
                } else {
                    showAlert('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>