<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>分析結果 - マッスルフォームアナライザー MVP</title>
  <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body data-bs-theme="dark">
  <div class="container">
    <header class="app-header">
      <h1 class="app-title">フォーム分析結果</h1>
      <p class="lead">{{ exercise_type|capitalize }}のフォーム評価</p>
    </header>
    
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">総合スコア</h2>
          </div>
          <div class="card-body text-center">
            <div class="gauge-container" data-score="{{ overall_score }}">
              <svg viewBox="0 0 200 200">
                <circle class="gauge-bg" cx="100" cy="100" r="85" stroke-width="15"></circle>
                <circle class="gauge-fill" cx="100" cy="100" r="85" stroke-width="15" transform="rotate(-90 100 100)"></circle>
                <text class="gauge-text" x="100" y="100">{{ overall_score }}</text>
                <text class="gauge-label" x="100" y="125">フォームスコア</text>
              </svg>
            </div>
            
            <div class="mt-4">
              <p class="fw-bold">{{ overall_assessment }}</p>
              <p>{{ overall_feedback }}</p>
              
              <div class="mt-3">
                <button onclick="playVoiceFeedback()" class="btn btn-secondary">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                    <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                    <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7.5 4v8a.5.5 0 0 1-.783.413l-2.5-1.5a.5.5 0 0 1-.217-.413v-4a.5.5 0 0 1 .217-.413l2.5-1.5z"/>
                  </svg>
                  音声フィードバック
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">
            <h2 class="card-title">動画分析</h2>
          </div>
          <div class="card-body">
            <div class="video-container">
              <video id="analysis-video" class="video-player" controls autoplay muted>
                <!-- Custom demo video fallback if no uploaded video available -->
                <source src="https://assets.mixkit.co/videos/preview/mixkit-exercising-in-the-gym-lifting-a-barbell-43074-large.mp4" type="video/mp4">
                お使いのブラウザは動画タグをサポートしていません。
              </video>
              <canvas class="skeleton-overlay"></canvas>
            </div>
            
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="heatmap-toggle" onchange="toggleHeatmap()">
                <label class="form-check-label" for="heatmap-toggle">筋肉ヒートマップを表示</label>
              </div>
              <button class="btn btn-sm btn-secondary" onclick="toggle3DComparison()">3D表示</button>
            </div>
            
            <div class="timeline-container">
              <div class="timeline-scrubber">
                <!-- Timeline frames will be generated by JavaScript -->
                <div class="playhead" style="left: 0%"></div>
              </div>
              <p class="text-muted small mt-1">赤い領域は問題のあるフレームを示します。クリックするとその時点にジャンプします。</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="comparison-viewer" style="display: none;">
      <div class="card mb-4">
        <div class="card-header">
          <h2 class="card-title">3D比較ビュー</h2>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-3">
            <span>あなたのフォーム</span>
            <span>理想的なフォーム</span>
          </div>
          <div style="height: 300px; background-color: rgba(0,0,0,0.2); border-radius: 0.5rem;"></div>
          <div class="mt-3">
            <label for="opacity-slider" class="form-label">モデルのブレンド</label>
            <input type="range" class="form-range" id="opacity-slider" min="0" max="100" value="50" onchange="updateModelOpacity(this.value)">
          </div>
        </div>
      </div>
    </div>
    
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="card-title">フィードバックの詳細</h2>
      </div>
      <div class="card-body">
        <h3 class="mb-3">検出された問題点</h3>
        
        {% for feedback in specific_feedback %}
        <div class="feedback-card" data-expanded="false">
          <div class="feedback-header">
            <div class="d-flex align-items-center">
              <div class="feedback-icon {% if '適切' in feedback or '良好' in feedback or '安定' in feedback %}success{% elif '不十分' in feedback %}warning{% else %}error{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  {% if '適切' in feedback or '良好' in feedback or '安定' in feedback %}
                  <!-- 成功アイコン -->
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                  {% elif '不十分' in feedback %}
                  <!-- 警告アイコン -->
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                  <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                  {% else %}
                  <!-- エラーアイコン -->
                  <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 10.5a.5.5 0 0 1-.708.708L8 8.707l-2.793 2.793a.5.5 0 0 1-.707-.708L7.293 8 4.5 5.207a.5.5 0 0 1 .707-.708L8 7.293l2.793-2.793a.5.5 0 0 1 .708.707L8.708 8l2.793 2.793z"/>
                  {% endif %}
                </svg>
              </div>
              <h4 class="feedback-title">
                {% if exercise_type == 'squat' %}
                  {% if loop.index == 1 %}膝のアライメント{% elif loop.index == 2 %}腰の位置{% elif loop.index == 3 %}スクワットの深さ{% endif %}
                {% elif exercise_type == 'bench' %}
                  {% if loop.index == 1 %}バーのパス{% elif loop.index == 2 %}肘の角度{% elif loop.index == 3 %}肩の安定性{% endif %}
                {% elif exercise_type == 'deadlift' %}
                  {% if loop.index == 1 %}背中の角度{% elif loop.index == 2 %}バーのパス{% elif loop.index == 3 %}股関節の動き{% endif %}
                {% else %}
                  {% if loop.index == 1 %}姿勢の安定性{% elif loop.index == 2 %}動作の一貫性{% elif loop.index == 3 %}フォームのバランス{% endif %}
                {% endif %}
              </h4>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="feedback-chevron" viewBox="0 0 16 16">
              <path d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>
            </svg>
          </div>
          <div class="feedback-body">
            <p>{{ feedback }}</p>
            <p><strong>推奨事項：</strong> {{ improvement_tips[loop.index0] }}</p>
            {% if not '適切' in feedback and not '良好' in feedback and not '安定' in feedback %}
            <p><strong>問題のあるフレーム：</strong> 
              {% if loop.index == 1 %}15-20, 75-80
              {% elif loop.index == 2 %}45-50
              {% else %}30-35
              {% endif %}
            </p>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="card-title">改善計画</h2>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-4 mb-md-0">
            <div class="card h-100">
              <div class="card-header bg-dark">
                <h5 class="card-title">短期的な修正点</h5>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  {% if exercise_type == 'squat' %}
                  <li>ボックススクワットで適切な深さを体感する</li>
                  <li>鏡を使って膝のアライメントを確認する</li>
                  <li>足首のモビリティエクササイズを行う</li>
                  <li>軽い重量でフォームに集中する</li>
                  {% elif exercise_type == 'bench' %}
                  <li>肩甲骨を引き寄せる練習をする</li>
                  <li>軽量バーでバーパスを確認する</li>
                  <li>正しい肘の角度を鏡で確認する</li>
                  <li>ベンチでの正しい姿勢を身につける</li>
                  {% elif exercise_type == 'deadlift' %}
                  <li>ヒップヒンジの動きを壁を使って練習する</li>
                  <li>背中の緊張を保つ練習をする</li>
                  <li>正しいセットアップ位置を練習する</li>
                  <li>軽い重量でフォームに集中する</li>
                  {% else %}
                  <li>基本動作の繰り返し練習</li>
                  <li>鏡を使ってフォームを確認する</li>
                  <li>動画撮影で自分のフォームを確認する</li>
                  <li>軽い重量で正しいテクニックを身につける</li>
                  {% endif %}
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4 mb-md-0">
            <div class="card h-100">
              <div class="card-header bg-dark">
                <h5 class="card-title">おすすめエクササイズ</h5>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  {% if exercise_type == 'squat' %}
                  <li>股関節屈筋のストレッチ</li>
                  <li>ゴブレットスクワット</li>
                  <li>膝の位置を確認するウォールシット</li>
                  <li>自重でのポーズスクワット</li>
                  {% elif exercise_type == 'bench' %}
                  <li>ダンベルプレス（様々な角度で）</li>
                  <li>プッシュアップ（肩甲骨の動きを意識）</li>
                  <li>バンドプルアパート（肩の安定性向上）</li>
                  <li>フロアプレス（肩甲骨の固定感覚）</li>
                  {% elif exercise_type == 'deadlift' %}
                  <li>ルーマニアンデッドリフト</li>
                  <li>ケトルベルスイング</li>
                  <li>グッドモーニング</li>
                  <li>シングルレッグデッドリフト</li>
                  {% else %}
                  <li>基礎的な体幹トレーニング</li>
                  <li>バランストレーニング</li>
                  <li>可動域を広げるストレッチ</li>
                  <li>フォームに焦点を当てた軽負荷エクササイズ</li>
                  {% endif %}
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-dark">
                <h5 class="card-title">進捗の追跡</h5>
              </div>
              <div class="card-body">
                <p>2週間後に新しい動画をアップロードして進捗を確認しましょう。以下に注目してください：</p>
                <ul class="mb-0">
                  {% if exercise_type == 'squat' %}
                  <li>足先に対する膝の位置</li>
                  <li>スクワットの深さ（腰の位置が膝より下）</li>
                  <li>足の中央部分に体重を維持する</li>
                  {% elif exercise_type == 'bench' %}
                  <li>バーのパスの一貫性</li>
                  <li>肘の角度が45度以内に保たれているか</li>
                  <li>肩甲骨がベンチに固定されているか</li>
                  {% elif exercise_type == 'deadlift' %}
                  <li>バーがシンに近い位置で動いているか</li>
                  <li>背中が丸まっていないか</li>
                  <li>股関節のヒンジ動作が効果的か</li>
                  {% else %}
                  <li>動作の安定性と一貫性</li>
                  <li>姿勢の改善点</li>
                  <li>フォームの全体的なバランス</li>
                  {% endif %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-center mb-5">
      <a href="/" class="btn btn-primary me-2">別の動画を分析する</a>
      <button class="btn btn-secondary" onclick="window.print()">レポートを保存</button>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/circle-gauge.js') }}"></script>
  <script src="{{ url_for('static', filename='js/skeleton-overlay.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize skeleton overlay
      const video = document.getElementById('analysis-video');
      const canvas = document.querySelector('.skeleton-overlay');
      
      if (video && canvas) {
        // Make sure video actually loads and plays
        video.addEventListener('error', function(e) {
          console.error('Video error:', e);
        });
        
        video.addEventListener('loadeddata', function() {
          console.log('Video loaded successfully');
        });
        
        // Try to trigger play manually after a short delay
        setTimeout(() => {
          video.play().catch(e => console.error('Could not play video:', e));
        }, 1000);
        
        // Initialize the skeleton overlay
        const overlay = new SkeletonOverlay(video, canvas);
      }
    });
  </script>
</body>
</html>