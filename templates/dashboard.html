<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>統計 - BodyScale</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="app-header">
                <h1 class="app-title">統計</h1>
                <p class="app-subtitle">トレーニング進捗・データ分析</p>
            </div>

            <!-- 統計カード -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">今月の統計</h2>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 600; color: var(--sub-accent); margin-bottom: 0.5rem;" id="workoutCount">-</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">ワークアウト数</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 600; color: var(--sub-accent); margin-bottom: 0.5rem;" id="totalVolume">-</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">総ボリューム(kg)</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 600; color: var(--sub-accent); margin-bottom: 0.5rem;" id="exerciseCount">-</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">実施種目数</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 最近のトレーニング -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">最近のトレーニング</h2>
                </div>
                <div class="card-body">
                    <div id="recentWorkouts" class="workout-list">
                        <div class="loading-skeleton">
                            <div class="skeleton" style="height: 60px; margin-bottom: 1rem;"></div>
                            <div class="skeleton" style="height: 60px; margin-bottom: 1rem;"></div>
                            <div class="skeleton" style="height: 60px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 進捗グラフ -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">進捗グラフ</h2>
                </div>
                <div class="card-body">
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <select id="exerciseSelect" class="form-control">
                            <option value="">種目を選択...</option>
                        </select>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-container">
                <a href="/" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span class="nav-label">ホーム</span>
                </a>
                <a href="/workout_record" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 11H7a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2v-7a2 2 0 00-2-2h-2M9 11V9a2 2 0 112 0v2M9 11h6"/>
                    </svg>
                    <span class="nav-label">記録</span>
                </a>
                <a href="/dashboard" class="nav-item active">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                    <span class="nav-label">統計</span>
                </a>
                <a href="/settings" class="nav-item">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    <span class="nav-label">設定</span>
                </a>
            </div>
        </nav>
    </div>

    <script>
        let progressChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadRecentWorkouts();
            loadExerciseList();
        });

        function loadDashboardData() {
            fetch('/get_dashboard_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('workoutCount').textContent = data.workout_count || 0;
                    document.getElementById('totalVolume').textContent = data.total_volume || 0;
                    document.getElementById('exerciseCount').textContent = data.exercise_count || 0;
                })
                .catch(error => {
                    console.error('統計データ読み込みエラー:', error);
                });
        }

        function loadRecentWorkouts() {
            fetch('/get_workouts?limit=5')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recentWorkouts');
                    
                    if (data.workouts && data.workouts.length > 0) {
                        container.innerHTML = data.workouts.map(workout => `
                            <div class="workout-item">
                                <div class="workout-header">
                                    <span class="exercise-name">${workout.exercise_name || workout.exercise}</span>
                                    <span class="workout-date">${workout.date}</span>
                                </div>
                                <div class="workout-details">
                                    ${workout.weight_kg}kg × ${workout.reps}回 × ${workout.sets}セット
                                    ${workout.notes ? `<span class="workout-notes">${workout.notes}</span>` : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="no-data">まだ記録がありません</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('recentWorkouts').innerHTML = '<p class="error">記録の読み込みに失敗しました</p>';
                });
        }

        function loadExerciseList() {
            fetch('/get_workouts?limit=100')
                .then(response => response.json())
                .then(data => {
                    const exerciseSelect = document.getElementById('exerciseSelect');
                    const exercises = [...new Set(data.workouts?.map(w => w.exercise) || [])];
                    
                    exercises.forEach(exercise => {
                        const option = document.createElement('option');
                        option.value = exercise;
                        option.textContent = exercise;
                        exerciseSelect.appendChild(option);
                    });
                    
                    exerciseSelect.addEventListener('change', function() {
                        if (this.value) {
                            loadProgressChart(this.value);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function loadProgressChart(exercise) {
            fetch(`/get_chart_progress/${exercise}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('progressChart').getContext('2d');
                    
                    if (progressChart) {
                        progressChart.destroy();
                    }
                    
                    progressChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.dates || [],
                            datasets: [{
                                label: '最大重量 (kg)',
                                data: data.weights || [],
                                borderColor: '#D4AF37',
                                backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#001130'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#001130'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#001130'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    </script>
</body>
</html>
            <!-- サイドバー -->
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <h5 class="text-primary">BodyScale</h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="/dashboard">
                                ダッシュボード
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/workout_log">
                                トレーニング記録
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                フォーム分析
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-10 ms-sm-auto px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ダッシュボード</h1>
                </div>

                <!-- 統計カード -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="trainingDays">-</div>
                            <div class="text-muted">今月のトレーニング日数</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="totalVolume">-</div>
                            <div class="text-muted">今月の総ボリューム(kg)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="prCount">-</div>
                            <div class="text-muted">記録した種目数</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center">
                            <div class="stat-number" id="topExercise">-</div>
                            <div class="text-muted">最頻種目</div>
                        </div>
                    </div>
                </div>

                <!-- 進捗グラフ -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card bg-dark">
                            <div class="card-header">
                                <h5>種目別進捗グラフ</h5>
                                <select id="exerciseSelect" class="form-select mt-2">
                                    <option value="">種目を選択...</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="progressChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 人気種目ランキング -->
                    <div class="col-md-4">
                        <div class="card bg-dark">
                            <div class="card-header">
                                <h5>人気種目TOP5</h5>
                            </div>
                            <div class="card-body">
                                <div id="topExercisesList">
                                    <!-- 動的に生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- カレンダー -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-dark">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>トレーニングカレンダー</h5>
                                <div>
                                    <button id="prevMonth" class="btn btn-sm btn-outline-secondary me-2">←</button>
                                    <span id="currentMonth"></span>
                                    <button id="nextMonth" class="btn btn-sm btn-outline-secondary ms-2">→</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="calendar-grid" id="calendarGrid">
                                    <!-- 動的に生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let progressChart = null;

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadExerciseOptions();
            updateCalendar();
        });

        // ダッシュボード統計の読み込み
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                document.getElementById('trainingDays').textContent = data.training_days || 0;
                document.getElementById('totalVolume').textContent = Math.round(data.total_volume || 0);
                document.getElementById('prCount').textContent = data.pr_count || 0;
                
                // 最頻種目
                const topExercise = data.top_exercises && data.top_exercises.length > 0 
                    ? data.top_exercises[0].exercise : '-';
                document.getElementById('topExercise').textContent = topExercise;
                
                // 人気種目リスト
                updateTopExercisesList(data.top_exercises || []);
                
            } catch (error) {
                console.error('統計データ読み込みエラー:', error);
            }
        }

        // 種目選択肢の読み込み
        async function loadExerciseOptions() {
            try {
                const response = await fetch('/api/max_weights');
                const data = await response.json();
                
                const select = document.getElementById('exerciseSelect');
                data.max_weights?.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.exercise;
                    option.textContent = item.exercise;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', function() {
                    if (this.value) {
                        loadProgressChart(this.value);
                    }
                });
                
            } catch (error) {
                console.error('種目選択肢読み込みエラー:', error);
            }
        }

        // 進捗グラフの読み込み
        async function loadProgressChart(exercise) {
            try {
                const response = await fetch(`/api/charts/progress/${encodeURIComponent(exercise)}`);
                const data = await response.json();
                
                const ctx = document.getElementById('progressChart').getContext('2d');
                
                if (progressChart) {
                    progressChart.destroy();
                }
                
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(item => new Date(item.date).toLocaleDateString('ja-JP')),
                        datasets: [{
                            label: `${exercise} 最大重量 (kg)`,
                            data: data.data.map(item => item.weight),
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#fff'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#fff'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#fff'
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('進捗グラフ読み込みエラー:', error);
            }
        }

        // 人気種目リストの更新
        function updateTopExercisesList(exercises) {
            const container = document.getElementById('topExercisesList');
            container.innerHTML = '';
            
            exercises.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'd-flex justify-content-between align-items-center mb-2';
                div.innerHTML = `
                    <span>${index + 1}. ${item.exercise}</span>
                    <span class="badge bg-primary">${item.count}回</span>
                `;
                container.appendChild(div);
            });
        }

        // カレンダーの更新
        async function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            
            document.getElementById('currentMonth').textContent = 
                `${year}年${month}月`;
            
            try {
                const response = await fetch(`/api/charts/calendar?year=${year}&month=${month}`);
                const data = await response.json();
                
                generateCalendar(year, month, data.training_days);
                
            } catch (error) {
                console.error('カレンダーデータ読み込みエラー:', error);
            }
        }

        // カレンダーの生成
        function generateCalendar(year, month, trainingDays) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // 曜日ヘッダー
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day text-center fw-bold';
                header.textContent = day;
                header.style.background = 'var(--bs-secondary)';
                grid.appendChild(header);
            });
            
            // 月の日数と開始曜日
            const firstDay = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            
            // 空白セルを追加
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day';
                grid.appendChild(empty);
            }
            
            // 日付セルを追加
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                cell.textContent = day;
                
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const trainingData = trainingDays.find(td => td.date === dateStr);
                
                if (trainingData) {
                    cell.classList.add('training');
                    cell.title = `${trainingData.workout_count}セット, ${trainingData.exercise_count}種目`;
                } else {
                    cell.classList.add('rest');
                }
                
                grid.appendChild(cell);
            }
        }

        // カレンダーナビゲーション
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        });
    </script>
</body>
</html>